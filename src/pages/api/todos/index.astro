---
export const partial = true;
import { db, Tasks, like } from 'astro:db';
import Task from '@/components/Task.astro';
import { nanoid } from 'nanoid';
import xss from 'xss';

const method = Astro.request.method;
// console.log(method);

const id = Astro.url.searchParams.get('id');
// console.log(id);

async function getTodo(id: string) {
  return await db
    .select()
    .from(Tasks)
    .where(like(Tasks.id, `%${id}%`))
    .get();
}
async function getText() {
  const formData = await Astro.request.formData();
  return formData.get('text');
}
let todo, text;

switch (method) {
  // add new task
  case 'POST':
    text = xss(String(await getText()));
    console.log(text);
    if (!text) break;
    const newTodo = { id: nanoid(), text } as unknown as Task;

    await db.insert(Tasks).values(newTodo);
    todo = newTodo;
    break;
  // update task
  case 'PUT':
    text = xss(String(await getText()));
    todo = id && (await getTodo(id));
    if (!text) break;
    await db
      .update(Tasks)
      .set({ text: `${text}` })
      .where(like(Tasks.id, `%${id}%`));
    todo = id && (await getTodo(id));
    break;
  case 'DELETE':
    await db.delete(Tasks).where(like(Tasks.id, `%${id}%`));
    break;
  // get text of task
  default:
    if (id === null) return;
    todo = await getTodo(id);
    break;
}

// console.log(todo);
---

{method === 'GET' && todo && <Task todo={todo} mode="edit" />}
{method === 'POST' && text && <Task todo={todo} />}
{method === 'PUT' && <Task todo={todo} />}

{method === 'DELETE' && id && null}
